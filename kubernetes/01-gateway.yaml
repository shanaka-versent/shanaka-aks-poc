# MTKC POC - Kubernetes Gateway API - Gateway Resource
# @author Shanaka Jayasundera - shanakaj@gmail.com
# This creates the Istio ingress gateway with an Internal Load Balancer
#
# IMPORTANT: This uses Gateway API (gateway.networking.k8s.io), NOT Ingress
# IMPORTANT: NOT using classic networking.k8s.io/v1 Ingress resources
#
# END-TO-END TLS CONFIGURATION:
# This Gateway supports both HTTP (port 80) and HTTPS (port 443)
# For HTTPS, it requires a TLS secret named 'istio-gateway-tls' in the istio-ingress namespace

---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: mtkc-gateway
  namespace: istio-ingress
spec:
  # Use Istio's Gateway API implementation (NOT IngressClass)
  gatewayClassName: istio

  # Infrastructure configuration for the auto-created Service
  infrastructure:
    annotations:
      # CRITICAL: This makes the LoadBalancer INTERNAL (not public)
      service.beta.kubernetes.io/azure-load-balancer-internal: "true"
    # NOTE: externalTrafficPolicy: Local is required for Azure ILB to work with
    # App Gateway. This must be set via kubectl patch after Gateway creation:
    # kubectl patch svc mtkc-gateway-istio -n istio-ingress -p '{"spec":{"externalTrafficPolicy":"Local"}}'

  listeners:
    # HTTP Listener (port 80)
    - name: http
      port: 80
      protocol: HTTP
      # hostname omitted = accepts all hostnames
      allowedRoutes:
        namespaces:
          from: All

    # HTTPS Listener (port 443) - End-to-End TLS
    - name: https
      port: 443
      protocol: HTTPS
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: istio-gateway-tls
            namespace: istio-ingress
      allowedRoutes:
        namespaces:
          from: All

---
# Alternative: If infrastructure.annotations doesn't work with your Istio version,
# create the Gateway with ClusterIP and add a separate Internal LB Service

# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: mtkc-gateway
#   namespace: istio-ingress
#   annotations:
#     # Force ClusterIP instead of LoadBalancer
#     networking.istio.io/service-type: ClusterIP
# spec:
#   gatewayClassName: istio
#   listeners:
#     - name: http
#       port: 80
#       protocol: HTTP
#       allowedRoutes:
#         namespaces:
#           from: All

# ---
# # Then create Internal LoadBalancer Service separately
# apiVersion: v1
# kind: Service
# metadata:
#   name: mtkc-gateway-ilb
#   namespace: istio-ingress
#   annotations:
#     service.beta.kubernetes.io/azure-load-balancer-internal: "true"
# spec:
#   type: LoadBalancer
#   selector:
#     istio.io/gateway-name: mtkc-gateway
#   ports:
#     - name: http
#       port: 80
#       targetPort: 80
#       protocol: TCP
#     - name: https
#       port: 443
#       targetPort: 443
#       protocol: TCP
